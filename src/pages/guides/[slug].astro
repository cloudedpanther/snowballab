---
import Layout from '../../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';
import { toAbsoluteUrl, withBase } from '../../utils/paths';

export async function getStaticPaths() {
  const entries = await getCollection('guides');
  return entries.map((entry) => ({
    params: { slug: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const base = import.meta.env.BASE_URL;
const site = import.meta.env.SITE ?? 'https://snowballlab.co.kr';
const pageUrl = toAbsoluteUrl(withBase(base, `/guides/${entry.id}/`), site);
const guidesUrl = toAbsoluteUrl(withBase(base, '/guides/'), site);
const homeUrl = toAbsoluteUrl(withBase(base, '/'), site);

const breadcrumbList = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: '홈', item: homeUrl },
    { '@type': 'ListItem', position: 2, name: '가이드', item: guidesUrl },
    { '@type': 'ListItem', position: 3, name: entry.data.title, item: pageUrl },
  ],
};

const article = {
  '@context': 'https://schema.org',
  '@type': 'Article',
  headline: entry.data.title,
  description: entry.data.description,
  url: pageUrl,
  publisher: {
    '@type': 'Organization',
    name: 'Snowballlab',
    url: homeUrl,
  },
};

const jsonLd = [breadcrumbList, article];
const { Content } = await render(entry);
---

<Layout
  title={`${entry.data.title} · Snowballlab`}
  description={entry.data.description}
  canonical={withBase(base, `/guides/${entry.id}/`)}
>
  <article class="space-y-6">
    <header>
      <h1 class="text-2xl font-semibold text-slate-900 dark:text-white md:text-3xl">
        {entry.data.title}
      </h1>
      <p class="mt-2 text-slate-600 dark:text-slate-300">{entry.data.description}</p>
    </header>
    <div
      class="guide-prose prose prose-slate dark:prose-invert max-w-none rounded-2xl border border-slate-200 bg-white/80 p-6 dark:border-slate-800 dark:bg-slate-900/40"
    >
      <Content />
    </div>
    <p class="text-sm text-slate-500 dark:text-slate-400">
      <a href={withBase(base, '/guides/')} class="hover:text-slate-700 dark:hover:text-slate-300"
        >← 가이드 목록</a
      >
    </p>
  </article>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} is:inline />
</Layout>
